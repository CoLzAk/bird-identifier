services:
  bird_identifier_api:
    build: .
    env_file:
      - .env
    volumes:
      - ./api:/api
      - ./model:/model
      - bird-captures:/captures
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    expose:
      - 8000
    networks:
      - clzk-net

  bird_detector:
    build: .
    env_file:
      - .env
    volumes:
      - ./detector:/detector
      - bird-captures:/captures
    depends_on:
      bird_identifier_api:
        condition: service_healthy
    restart: unless-stopped
    command: python /detector/bird_detector.py
    networks:
      - clzk-net

volumes:
  bird-captures:
    driver: local
    driver_opts:
      type: none
      device: ${PWD}/captures
      o: bind

networks:
  clzk-net:
    external: false
    name: clzk-net
    driver: bridge
